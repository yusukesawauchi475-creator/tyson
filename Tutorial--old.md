# ※このドキュメントは「新スレに毎回読ませる唯一のSSOT」
# ※あなたがAPI/秘密を貼る場所は「5章」だけ。その他はこのまま固定でOK。

VERSION: 2026-02-06T00:00:00Z
OWNER: yusukesawauchi (.475@gmail)
PROJECT_PATH: ~/mixc-nekolist/Tyson

======================================================================
0. このドキュメントのルール（絶対）
======================================================================
- これは Tyson の唯一のSSOT（Single Source of Truth）
- 新スレは必ず最初にこれを読む（読ませる）
- 推測・補完は禁止。書いてあることだけを真実とする
- 秘密情報（APIキー/env実値/トークン/ID等の実値）は「5章」にのみ置く
- それ以外（チャット/MD/ログ/コード）に実値を出すのは禁止
- 進捗判定は「通った事実＋証拠」がすべて（口頭OKは無効）


======================================================================
0.5. 本プロジェクト思想
======================================================================
目的

Tyson は「親子で毎日1分の声を往復させる」アプリ。
中心体験は 親が話す → 子が聞いて返す → 親が翌日聞いてまた話す のループを回すこと。

コアループ（毎日）

親（送信者）：1日1回、1分話す（録音→送信）

送信が成功すると、その日の ぼやけた写真が少しクリアになる（進捗の可視化）

子（受信者）：親の音声を聞く → 返事を録音→送信

翌日：親は子の返事を聞く → また1分話す

これを繰り返して、親子の記録と関係を積み上げる

画面の役割（重要）

親画面は「再生だけ」ではなく、録音・送信もする（主役）

子画面も同様に、受信→再生→録音→送信を行う

どちらも「届いた/届いてない」が明確で、操作ミスが起きないことが最優先

UXの原則

毎日やらせない：できない日があっても責めない・壊れない

負担ゼロ：迷う設定や複雑操作は排除

データ喪失ゼロ：保存成功が確認できたときだけ「送信しました」を出す

最新が必ず再生される：相手側で “古い音声が残る/キャッシュで更新されない” を絶対に起こさない

技術的に守るべき振る舞い（体験を壊さないため）

同じ日の2回目送信があり得る（撮り直し/言い直し）
→ 最新が必ず相手に反映される設計にする（上書きorバージョン管理、ただし相手側は常に最新だけ聴ける）

======================================================================
1. ゴール（絶対）
======================================================================
【長期】
- 100Mアプリ：親子（家族）の習慣・記録・振り返りプラットフォーム

【短期（常に今）】
- 親が「今日」使える Web MVP（iPhone/Android の Safari/Chrome で動く）

【最上位制約】
- データ喪失ゼロ
  - 録音したのに消えた／保存されてない／上書き事故 → 即死
  - “成功表示”は「保存完了の証拠」が取れたときのみ


======================================================================
2. プロダクト思想（不変）
======================================================================
- 1日1分、LINEより軽い「声のルーティン」
- 継続が価値：データが貯まるほど振り返り・変化検知・AI価値が上がる
- 親に責任を負わせないUX
  - 失敗しても親が設定/調査して直す前提にしない
  - 画面のエラー表示は1行だけ（詳細はログ側）

======================================================================
3. 技術スタック（確定）
======================================================================
- Frontend: Vite + React
- Hosting / Serverless: Vercel
- Backend / Data: Firebase
  - Auth（匿名ログイン）
  - Firestore（メタデータ）
  - Storage（音声/画像などバイナリ）
- Routing: HashRouter（/#/）
  - 目的：SPA fallback/直叩き事故を避け「確実に表示」を優先

======================================================================
4. 画面仕様（MVP）
======================================================================
【子（録音・送信）】
- Route: /#/tyson
- 録音（開始→停止）
- 停止後に自動アップロード
- 状態表示（最低限）：
  - 録音中…
  - 送信中…
  - 送信しました（時刻）
- 無音/不正録音の扱い（保存事故防止）：
  - duration < 1s または blob < 4KB はアップロードしない（再録促し）

【親（受信確認・再生）】
- Route: /#/
- 文言：
  - 「今日は声が届いています」 or 「まだです（今日はこれで大丈夫です）」
- 操作：
  - 更新（到着確認）
  - 再生（音声があるときのみ有効）
- 親は“調査員”にならない：詳細ログ/設定導線は出さない

======================================================================
5. 環境変数・API（ここだけあなたが埋める）
======================================================================
※この章だけに「実値」を置く。他の章やチャットに絶対貼らない。

5.1 Client（Vite / Browser）Firebase Web Config（.env.local）
VITE_FIREBASE_API_KEY=AIzaSyCmQ1y44N01a8t0E-j_6CHgFvAtzN4HWaA
VITE_FIREBASE_AUTH_DOMAIN=tyson-3341f.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=tyson-3341f
VITE_FIREBASE_STORAGE_BUCKET=tyson-3341f.firebasestorage.app
VITE_FIREBASE_MESSAGING_SENDER_ID=486892592677
VITE_FIREBASE_APP_ID=1:486892592677:web:04c067c0490ffd54f869cc
VITE_FIREBASE_MEASUREMENT_ID=G-VL4GMBX48R

5.2 Serverless（Vercel Env / Secrets）
- FIREBASE_SERVICE_ACCOUNT=       （JSON全文）
- OPENAI_API_KEY=
- ADMIN_PASSWORD=                 （必要なら）

======================================================================
6. URL / ルーティング（秘密なし）
======================================================================
【Production (Vercel)】
- 親（再生・確認）: https://tyson-two.vercel.app/#/
- 子（録音・送信）: https://tyson-two.vercel.app/#/tyson

【HashRouter方針】
- # 以降がルート。親=/#/、子=/#/tyson を必ず使い分ける
- 目的：VercelのSPA fallback問題や直叩き事故を回避し「確実に表示」

======================================================================
7. データフロー（正規の一本道）
======================================================================
- 正式フロー：録音 → API → Storage → Firestore → 親購読 → 再生
- 成功条件（“1回通し”の証拠）：
  - Storage: fullPath または downloadURL が確定
  - Firestore: 該当 dateKey のドキュメントが exists=true
  - 親: 購読反映後に再生が最後まで完了（ended）

======================================================================
8. データ保全ルール（Engineering SSOT）
======================================================================
- 2段階コミット（概念）
  1) Storageにバイナリ保存（成功しない限り成功扱いしない）
  2) Firestoreにメタ確定（保存先・mime・時刻など）
- 冪等：途中で落ちても再実行できる設計
- “成功表示”はサーバ保存完了の証拠が取れてから

======================================================================
9. iOS Safari（最終ボス前提）
======================================================================
- 録音フォーマットは通りやすい順に試す：
  - audio/mp4 → audio/aac → webm(opus) → webm
- iOSで無音blobが出やすいので、無音判定（duration/blobサイズ）を必ず通す

======================================================================
10. 作業ルール（運用）
======================================================================
- UI修理より「保存の証拠」を最優先
- 曖昧点・提案がある場合は “実装前に質問して確定”
- 小さく変更し、検証後に撤去できる形で進める

======================================================================
11. 新スレ引き継ぎ（11以降は固定テンプレ）
======================================================================
目的：新スレでも「いつでもこの状態（録音→保存→相手が再生）に戻れる」こと。

----------------------------------------------------------------------
11.1 戻れる最低ライン（固定）
----------------------------------------------------------------------
順番は必ずこの通り：

1) `npm run dev:all`
2) ローカルで 1往復（子→送信→親で再生）成功
3) Firebase Storage で当日 `dateKey(YYYY-MM-DD)` の parent/child 両方に mp4 があること
   - pair-media/<pairId>/<dateKey>/parent/recording.mp4
   - pair-media/<pairId>/<dateKey>/child/recording.mp4
4) 本番（Vercel）で 2往復（子→親、親→子）

ローカルURL（固定）：
- 親: http://localhost:5173/#/
- 子: http://localhost:5173/#/tyson

本番URL（固定）：
- 親: https://tyson-two.vercel.app/#/
- 子: https://tyson-two.vercel.app/#/tyson

----------------------------------------------------------------------
11.2 証拠の取り方（固定）
----------------------------------------------------------------------
トラブル時に貼るのはこの3点だけ（順番もこのまま）：

1) ターミナルログ（`npm run dev:all` 側）の `[OBSERVE]` を含むログ
2) 画面の Request ID（REQ-XXXX）
3) Storage の該当パスが分かるスクショ（当日 `dateKey` フォルダ、parent/child）

※ 障害調査の一次ソースは Network ではなくターミナルログ（[OBSERVE]）。

----------------------------------------------------------------------
11.3 既知エラー集（短く）
----------------------------------------------------------------------
- `analyze mismatch` → `200 skipped`
  - 正常系のスキップ。赤字扱いにしない（調査対象にしない）
- Network が空 / 捕まらない
  - Console/Network ではなくターミナル一次ソースで判断（[OBSERVE]）

----------------------------------------------------------------------
11.4 親に渡す運用（1枚）
----------------------------------------------------------------------
毎日これだけ（親に説明する文章そのまま）：

- 1日30秒〜1分、録音→送信（連打しない）
- 聴く側は 開いて待つ（自動更新）→再生
- 未再生は ● が付く（再生したら消える）
- うまくいかなければ アプリを閉じて開き直し → もう一度だけ
- それでもダメなら REQ-XXXX を送る（スクショ1枚もあれば尚良い）


======================================================================
12. 既知の不具合・対応履歴（新スレが迷わないため）
======================================================================
[2026-02-08〜] 双方向音声の不具合修正（同じ/昔の音が出る）

原因（確定）：
- Firestore旧スキーマ（audioPath直下）と新スキーマ（parent/child）不一致
- 旧パス保存（role無し）とキャッシュ/取得の混線

対応（確定）：
api/pair-media.js
- POST：role必須（parent|child）、role入りobjectPathを強制
  保存パス：pair-media/<pairId>/<dateKey>/<role>/recording.mp4
- GET：新スキーマ優先。旧互換は parent のみ（childへ旧音声を返さない）
- OBSERVEログ：objectPath / resolvedAudioPath / isLegacy を統一出力（秘密値禁止）

フロント（src/lib/pairDaily.js）
- fetchに cache buster（v=Date.now） + cache:'no-store'
- 毎回取り直す・古いblob URLは revoke（使い回し禁止）

検証（確定）：
- npm run dev:all でローカル
- 2端末（親/#/、子/#/tyson）で互いに 録音→更新→再生 が成立
- Firebase Storage に parent/child 別で recording.mp4 が残ることを確認

----------------------------------------------------------------------
[2026-02-15] AI解析（/api/analyze）が体験を壊す問題
----------------------------------------------------------------------
症状：
- 解析開始時のガードで source_version_mismatch_on_start が出て、UIが赤字 “うまくいきませんでした” に見える

結論：
- 解析の失敗で録音/保存体験を壊してはいけない（MVP最優先は音声の保存と再生）

対応（確定）：
api/analyze.js
- source_version_mismatch_on_start は 500 にしない
- 200で { success:true, skipped:true, reason:'source_version_mismatch_on_start' } を返す
- OBSERVEログに clientVersion / serverVersion / action を出す（秘密値禁止）

======================================================================
13. 障害時チェックリスト（最短で復旧）
======================================================================
(0) まず “どこで起きてるか” を分ける
- ローカル（localhost）だけ壊れてる？ それとも本番（tyson-two）も？
  → ローカルが壊れてるだけなら、まず npm run dev:all で復旧確認。

(1) ローカルで 500 が出る
- 必ず npm run dev:all のターミナルログを見る（スタック全文）
- よくある原因：
  - server.js が動いていない（viteだけ起動している）
  - env/サービスアカウントが読み込めていない（5章の設定）
  - multipart parse / Firebase write で例外

(2) Storageにファイルが残るのに、相手が“届かない”
- Firestoreの当日ドキュメントが exists か確認（メタが書けていない可能性）
- GETが listenRole を誤っている可能性（ログで listenRole を確認）

(3) “Networkに何も出ない”
- 発生直後でないと捕まらない。Networkよりターミナルログで確定する。

======================================================================
14. 親に渡す運用（MVPの最低ライン）
======================================================================
- 毎日1回：30秒〜1分 しゃべって 録音→送信（連打しない）
- 聴く側：更新→再生
- 失敗したら：
  1) ページ閉じて開き直し
  2) もう一度だけ送信
  3) それでもダメなら 画面の REQ-XXXX を送る（サポート用）

AIコメントは “おまけ”。録音/保存/再生が最優先。

